<!doctype html>
<html>
  <head>
    <title>BookImg - AI Book Recognition</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .upload-area {
        border: 2px dashed #ccc;
        padding: 40px;
        text-align: center;
        margin: 20px 0;
      }
      .upload-area.dragover {
        border-color: #007bff;
        background-color: #f8f9fa;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .status {
        margin: 20px 0;
        padding: 10px;
        border-radius: 4px;
      }
      .status.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .status.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .status.info {
        background: #cce7ff;
        border: 1px solid #99d6ff;
        color: #004085;
      }
    </style>
  </head>
  <body>
    <h1>ðŸ“š BookImg - AI Book Recognition</h1>
    <p>
      Upload a photo of your bookshelf to extract book titles and authors using
      AI.
    </p>

    <div class="upload-area" id="uploadArea">
      <input
        type="file"
        name="image"
        accept="image/*"
        required
        id="fileInput"
      />
      <br /><br />
      <button type="button" id="uploadBtn" onclick="handleUpload()">
        Upload Image
      </button>
    </div>

    <div id="status"></div>

    <script>
      // Drag and drop functionality
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
        }
      });

      let websocket = null;

      // Handle upload
      async function handleUpload() {
        const file = fileInput.files[0];
        if (!file) {
          document.getElementById("status").innerHTML =
            '<div class="status error">No file selected</div>';
          return;
        }

        document.getElementById("status").innerHTML =
          '<div class="status info">Getting upload URL...</div>';

        try {
          // Get pre-signed URL
          const response = await fetch(
            "upload-url?filename=" +
              encodeURIComponent(file.name) +
              "&contentType=" +
              encodeURIComponent(file.type),
            {
              method: "GET",
            },
          );

          if (!response.ok) {
            throw new Error("Failed to get upload URL");
          }

          const signedUrl = await response.text();

          // Extract jobId from signed URL
          const urlParts = new URL(signedUrl);
          const s3Key = urlParts.pathname.substring(1); // Remove leading slash
          const jobId = s3Key.split("/")[0]; // Get directory name as jobId

          document.getElementById("status").innerHTML =
            '<div class="status info">Uploading to AWS S3...</div>';

          // Connect to WebSocket before uploading
          await connectWebSocket(jobId);

          // Upload to S3
          const uploadResponse = await fetch(signedUrl, {
            method: "PUT",
            body: file,
            headers: {
              "Content-Type": file.type,
            },
          });

          if (uploadResponse.ok) {
            document.getElementById("status").innerHTML =
              '<div class="status info">Upload successful! Processing started...<br><small>Job ID: ' +
              jobId +
              "</small></div>";
          } else {
            document.getElementById("status").innerHTML =
              '<div class="status error">Upload failed</div>';
            if (websocket) websocket.close();
          }
        } catch (error) {
          document.getElementById("status").innerHTML =
            '<div class="status error">Upload error: ' +
            error.message +
            "</div>";
          if (websocket) websocket.close();
        }
      }

      async function connectWebSocket(jobId) {
        return new Promise((resolve, reject) => {
          websocket = new WebSocket("{{WEBSOCKET_API_URL}}");

          websocket.onopen = function () {
            console.log("WebSocket connected");
            // Subscribe to job notifications
            websocket.send(
              JSON.stringify({
                action: "subscribe",
                jobId: jobId,
              }),
            );
            resolve();
          };

          websocket.onmessage = function (event) {
            try {
              const data = JSON.parse(event.data);
              console.log("WebSocket message:", data);

              if (data.type === "subscribed") {
                document.getElementById("status").innerHTML =
                  '<div class="status info">ðŸ”— Connected to real-time updates</div>';
              } else if (data.type === "processingComplete") {
                const results = data.results;
                if (results && results.books && results.books.length > 0) {
                  let booksHtml = "<h3>ðŸ“š Books Found:</h3><ul>";
                  results.books.forEach((book) => {
                    const title = book.validation?.title || book.title;
                    const authors =
                      book.validation?.authors?.join(", ") || book.author;
                    booksHtml +=
                      "<li><strong>" + title + "</strong> by " + authors;
                    if (book.validation?.isbn) {
                      booksHtml += " (ISBN: " + book.validation.isbn + ")";
                    }
                    booksHtml += "</li>";
                  });
                  booksHtml += "</ul>";

                  document.getElementById("status").innerHTML =
                    '<div class="status success">ðŸŽ‰ Processing Complete!<br>' +
                    "<small>Found " +
                    results.totalCandidates +
                    " candidates, validated " +
                    results.validatedBooks +
                    " books</small>" +
                    booksHtml +
                    "</div>";
                } else {
                  document.getElementById("status").innerHTML =
                    '<div class="status info">Processing complete - no books found in image</div>';
                }
                websocket.close();
              }
            } catch (e) {
              console.error("Error parsing WebSocket message:", e);
            }
          };

          websocket.onerror = function (error) {
            console.error("WebSocket error:", error);
            reject(error);
          };

          websocket.onclose = function () {
            console.log("WebSocket disconnected");
          };
        });
      }
    </script>
  </body>
</html>
