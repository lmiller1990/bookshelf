#!/bin/bash

# Deploy Frontend Script
# Reads Terraform outputs and deploys Vue app to S3 + CloudFront

set -e  # Exit on error

echo "ðŸš€ Starting frontend deployment..."

# Check if we're in the right directory
if [ ! -f "terraform/main.tf" ]; then
    echo "âŒ Error: Must run from project root directory (where terraform/ folder exists)"
    exit 1
fi

# Check if terraform outputs are available
echo "ðŸ“‹ Reading Terraform outputs..."
cd terraform

if ! terraform output frontend_bucket_name > /dev/null 2>&1; then
    echo "âŒ Error: Terraform outputs not found. Run 'terraform apply' first."
    exit 1
fi

# Get infrastructure values from Terraform
FRONTEND_BUCKET=$(terraform output -raw frontend_bucket_name)
CLOUDFRONT_ID=$(terraform output -raw frontend_cloudfront_distribution_id)
CLOUDFRONT_URL=$(terraform output -raw frontend_cloudfront_url)
API_BASE_URL=$(terraform output -raw web_api_url)
WEBSOCKET_URL=$(terraform output -raw websocket_api_url)

echo "ðŸ“¦ Target S3 bucket: $FRONTEND_BUCKET"
echo "ðŸŒ CloudFront distribution: $CLOUDFRONT_ID"
echo "ðŸ”Œ API Base URL: $API_BASE_URL"
echo "ðŸ”— WebSocket URL: $WEBSOCKET_URL"

cd ..

# Build the Vue app
echo "ðŸ”¨ Building Vue frontend..."
cd packages/frontend

if [ ! -f "package.json" ]; then
    echo "âŒ Error: Frontend package.json not found"
    exit 1
fi

# Generate .env file with actual URLs from Terraform
echo "ðŸ”§ Generating environment variables..."
cat > .env << EOF
# Generated by deploy script - DO NOT EDIT
VITE_API_BASE_URL=$API_BASE_URL
VITE_WEBSOCKET_URL=$WEBSOCKET_URL
EOF

echo "âœ… Environment variables written to .env"

# Install dependencies and build
pnpm install
pnpm run build

if [ ! -d "dist" ]; then
    echo "âŒ Error: Build failed - dist directory not created"
    exit 1
fi

echo "âœ… Build completed"

# Deploy to S3
echo "ðŸ“¤ Uploading to S3..."

# Upload all files except index.html with default caching
aws s3 sync dist/ s3://$FRONTEND_BUCKET --delete --profile bookimg-deployer --exclude "index.html"

# Upload index.html with no-cache headers
aws s3 cp dist/index.html s3://$FRONTEND_BUCKET/index.html --profile bookimg-deployer \
  --cache-control "no-cache, no-store, must-revalidate" \
  --metadata-directive REPLACE

if [ $? -eq 0 ]; then
    echo "âœ… S3 upload completed"
else
    echo "âŒ Error: S3 upload failed"
    exit 1
fi

# Invalidate CloudFront cache
echo "ðŸ”„ Invalidating CloudFront cache..."
INVALIDATION_ID=$(aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_ID --paths '/*' --profile bookimg-deployer --query 'Invalidation.Id' --output text)

if [ $? -eq 0 ]; then
    echo "âœ… CloudFront invalidation created: $INVALIDATION_ID"
    echo "ðŸŒ Frontend will be available at: $CLOUDFRONT_URL"
    echo "â° Cache invalidation may take 5-10 minutes to complete"
else
    echo "âŒ Error: CloudFront invalidation failed"
    exit 1
fi

echo ""
echo "ðŸŽ‰ Frontend deployment completed successfully!"
echo "ðŸ”— URL: $CLOUDFRONT_URL"
echo ""
echo "Note: If this is the first deployment, it may take 10-15 minutes"
echo "for the CloudFront distribution to fully deploy."